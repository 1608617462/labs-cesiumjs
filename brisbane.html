<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
        <title>CartoDB - Cesium example (simple)</title>
        <link href="//cartodb-libs.global.ssl.fastly.net/cartodbui/assets/3.4.9/favicons/favicon.ico?1411985985" rel="shortcut icon" type="image/vnd.microsoft.icon" />
        <style>
            @import url(Cesium/Widgets/widgets.css);

            @import url(Cesium/Widgets/lighter.css);

            html {
                height: 100%;
            }

            body {
                background: #000;
                color: #eee;
                font-family: sans-serif;
                font-size: 9pt;
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            .fullSize {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                border: none;
                width: 100%;
                height: 100%;
            }

            #loadingOverlay {
                position: absolute;
                top: 0;
                left: 0;
                opacity: 0.9;
                width: 100%;
                height: 100%;
                display: none;
            }

            #loadingOverlay h1 {
                text-align: center;
                position: relative;
                top: 50%;
                margin-top: -0.5em;
            }

            #toolbar {
                margin: 5px;
                padding: 2px 5px;
                position: absolute;
                background: rgba(42, 42, 42, 0.8);
                padding: 4px;
                border-radius: 4px;
            }
            #toolbar input {
                vertical-align: middle;
                padding-top: 2px;
                padding-bottom: 2px;
            }
            #toolbar table tr {
                transform: translateY(0);
                transition: transform 0.4s ease-out;
            }
            #toolbar table tr.up {
                transform: translateY(33px);
                transition: none;
            }
            #toolbar table tr.down {
                transform: translateY(-33px);
                transition: none;
            }
        </style>
    </head>
    <body>
        <div id="cesiumContainer" class="fullSize"></div>
        <div id="loadingOverlay"><h1>Loading...</h1></div>
        <div id="toolbar">
        <table><tbody data-bind="foreach: layers">
            <tr data-bind="css: { up: $parent.upLayer === $data, down: $parent.downLayer === $data }">
                <td><input type="checkbox" data-bind="checked: show"></td>
                <td>
                    <span data-bind="text: name, visible: !$parent.isSelectableLayer($data)"></span>
                    <select data-bind="visible: $parent.isSelectableLayer($data), options: $parent.baseLayers, optionsText: 'name', value: $parent.selectedLayer"></select>
                </td>
                <td>
                    <input type="range" min="0" max="1" step="0.01" data-bind="value: alpha, valueUpdate: 'input'">
                </td>
                <td><button type="button" class="cesium-button" data-bind="click: function() { $parent.raise($data, $index()); }, visible: $parent.canRaise($index())">▲</button></td>
                <td><button type="button" class="cesium-button" data-bind="click: function() { $parent.lower($data, $index()); }, visible: $parent.canLower($index())">▼</button></td>
            </tr>
        </tbody></table>
        </div>


        <script src="Cesium/Cesium.js"></script>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.core.js"></script>
        <script src="cesium-cartodb.min.js"></script>
        <script>
            /*
                code based on the layers manipulation Cesium example
                http://cesiumjs.org/Cesium/Apps/Sandcastle/index.html?src=Imagery%20Layers%20Manipulation.html&label=Showcases
            */
            var viewer = new Cesium.Viewer('cesiumContainer', {
                baseLayerPicker : false
            });
            var imageryLayers = viewer.imageryLayers;

            var viewModel = {
                layers : [],
                baseLayers : [],
                upLayer : null,
                downLayer : null,
                selectedLayer : null,
                isSelectableLayer : function(layer) {
                    return baseLayers.indexOf(layer) >= 0;
                },
                raise : function(layer, index) {
                    imageryLayers.raise(layer);
                    viewModel.upLayer = layer;
                    viewModel.downLayer = viewModel.layers[Math.max(0, index - 1)];
                    updateLayerList();
                    window.setTimeout(function() { viewModel.upLayer = viewModel.downLayer = null; }, 10);
                },
                lower : function(layer, index) {
                    imageryLayers.lower(layer);
                    viewModel.upLayer = viewModel.layers[Math.min(viewModel.layers.length - 1, index + 1)];
                    viewModel.downLayer = layer;
                    updateLayerList();
                    window.setTimeout(function() { viewModel.upLayer = viewModel.downLayer = null; }, 10);
                },
                canRaise : function(layerIndex) {
                    return layerIndex > 0;
                },
                canLower : function(layerIndex) {
                    return layerIndex >= 0 && layerIndex < imageryLayers.length - 1;
                }
            };
            Cesium.knockout.track(viewModel);

            var baseLayers = viewModel.baseLayers;

            function setupLayers(tiles) {
                addBaseLayerOption(
                        'Bing Maps Aerial',
                        undefined); // the current base layer
                addBaseLayerOption(
                        'CartoDB Light',
                        new Cesium.CartoDBImageryProvider({
                            url: 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
                        }));
                addBaseLayerOption(
                        'CartoDB Dark',
                        new Cesium.CartoDBImageryProvider({
                            url: 'http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
                        }));
                addBaseLayerOption(
                        'CartoDB Flat Blue',
                        new Cesium.CartoDBImageryProvider({
                            url: 'https://cartocdn_a.global.ssl.fastly.net/base-flatblue/{z}/{x}/{y}.png'
                        }));
                tiles.forEach(function(tileObj){
                    // Create the additional layers
                    addAdditionalLayerOption(
                        tileObj.name,
                        new Cesium.CartoDBImageryProvider({ url: tileObj.tiles.tiles[0] }),
                        tileObj.alpha,
                        tileObj.show
                    );
                });

            }

            function addBaseLayerOption(name, imageryProvider) {
                var layer;
                if (typeof imageryProvider === 'undefined') {
                    layer = imageryLayers.get(0);
                    viewModel.selectedLayer = layer;
                } else {
                    layer = new Cesium.ImageryLayer(imageryProvider);
                }

                layer.name = name;
                baseLayers.push(layer);
            }

            function addAdditionalLayerOption(name, imageryProvider, alpha, show) {
                var layer = imageryLayers.addImageryProvider(imageryProvider);
                layer.alpha = Cesium.defaultValue(alpha, 0.5);
                layer.show = Cesium.defaultValue(show, true);
                layer.name = name;
                Cesium.knockout.track(layer, ['alpha', 'show', 'name']);
            }

            function updateLayerList() {
                var numLayers = imageryLayers.length;
                viewModel.layers.splice(0, viewModel.layers.length);
                for (var i = numLayers - 1; i >= 0; --i) {
                    viewModel.layers.push(imageryLayers.get(i));
                }
            }

            // Tile data layer (Ward offices)
            var layerWard = {
                user_name: 'jsanz',
                sublayers: [{
                    sql: 'SELECT * FROM ward_offices',
                    cartocss: '#ward_offices {polygon-opacity: 0.7; line-color: #FFF; line-width: 0.5; line-opacity: 1; } #ward_offices[political_="ALP"] {polygon-fill: #A6CEE3; } #ward_offices[political_="IND"] {polygon-fill: #1F78B4; } #ward_offices[political_="LNP"] {polygon-fill: #B2DF8A; }'
                    }]
                };

            var layerNEarth = {
                user_name: 'jsanz',
                sublayers:[{
                    sql: 'SELECT * FROM ne_10m_populated_places_simple_7',
                    cartocss: '#ne_10m_populated_places_simple_7{marker-fill-opacity: 0.6; marker-line-color: #FFF; marker-line-width: 1.5; marker-line-opacity: 1; marker-width: 21.5; marker-fill: #FFFFCC; marker-allow-overlap: true; marker-comp-op: multiply; } #ne_10m_populated_places_simple_7 [ pop_max <= 35676000] {marker-fill: #0C2C84; } #ne_10m_populated_places_simple_7 [ pop_max <= 2769072] {marker-fill: #225EA8; } #ne_10m_populated_places_simple_7 [ pop_max <= 578470] {marker-fill: #1D91C0; } #ne_10m_populated_places_simple_7 [ pop_max <= 345604] {marker-fill: #41B6C4; } #ne_10m_populated_places_simple_7 [ pop_max <= 139843] {marker-fill: #7FCDBB; } #ne_10m_populated_places_simple_7 [ pop_max <= 42097] {marker-fill: #C7E9B4; } #ne_10m_populated_places_simple_7 [ pop_max <= 41316] {marker-fill: #FFFFCC; }'
                }]
            }

            cartodb.Tiles.getTiles(layerWard, function (tilesWard, err) {
                cartodb.Tiles.getTiles(layerNEarth, function (tilesNEarth, err) {

                if (tilesWard == null || tilesNEarth == null) {
                    console.log("error: ", err.errors.join('\n'));
                    return;
                }

                setupLayers([
                {
                    name: 'Natural Earth Populated Places',
                    tiles: tilesNEarth,
                    alpha: 1,
                    show: false
                },
                {
                    name: 'Brisbane Ward Offices',
                    tiles: tilesWard,
                    alpha: 1,
                    show: true
                }
                ]);
                updateLayerList();

                //Bind the viewModel to the DOM elements of the UI that call for it.
                var toolbar = document.getElementById('toolbar');
                Cesium.knockout.applyBindings(viewModel, toolbar);

                Cesium.knockout.getObservable(viewModel, 'selectedLayer').subscribe(function(baseLayer) {
                    // Handle changes to the drop-down base layer selector.
                    var activeLayerIndex = 0;
                    var numLayers = viewModel.layers.length;
                    for (var i = 0; i < numLayers; ++i) {
                        if (viewModel.isSelectableLayer(viewModel.layers[i])) {
                            activeLayerIndex = i;
                            break;
                        }
                    }
                    var activeLayer = viewModel.layers[activeLayerIndex];
                    var show = activeLayer.show;
                    var alpha = activeLayer.alpha;
                    imageryLayers.remove(activeLayer, false);
                    imageryLayers.add(baseLayer, numLayers - activeLayerIndex - 1);
                    baseLayer.show = show;
                    baseLayer.alpha = alpha;
                    updateLayerList();
                });


                /*
                // SQL API layer (rendered by Cesium - bubbles)
                var dataSource = new Cesium.GeoJsonDataSource();
                viewer.dataSources.add(dataSource);

                var sql = new cartodb.SQL({user: 'jsanz', format: 'geoJSON'});
                sql.execute("SELECT cartodb_id, ST_Centroid(the_geom) the_geom, councillor, political_, ward, ward_code FROM jsanz.ward_offices")
                        .done(function (data) {
                            dataSource.load(data)
                                    .then(function () {
                                    })
                        })
                        .error(function (errors) {
                            // errors contains a list of errors
                            console.log("errors:" + errors);
                        });
                */

                // Select the CartoDB Light layer as base
                viewModel.selectedLayer = viewModel.baseLayers[1];

                // zoom to a position
                var ellipsoid = Cesium.Ellipsoid.WGS84;
                var west = Cesium.Math.toRadians(152);
                var south = Cesium.Math.toRadians(-29);
                var east = Cesium.Math.toRadians(153.7);
                var north = Cesium.Math.toRadians(-28);
                var rotation = Cesium.Math.toRadians(30);

                var extent = new Cesium.Rectangle(west, south, east, north);
                viewer.camera.viewRectangle(extent, ellipsoid);
                viewer.camera.lookUp(rotation);
            });
        });


        </script>
    </body>
</html>
